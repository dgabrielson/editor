tinymce.PluginManager.add('gapfill', function(editor) {
	/*
	editor.addButton('image', {
		icon: 'image',
		tooltip: 'Insert/edit image',
		onclick: imageDialog,
		stateSelector: 'img:not([data-mce-object],[data-mce-placeholder])'
	});
	*/

	function gapfillHTML(n) {
		return '<gapfill class="mceNonEditable">'+n+'</gapfill>'
	}
	function gapfillText(n) {
		return '[['+n+']]';
	}

	function replaceGapfills(content) {
		return content.replace(/\[\[(\d+)\]\]/g,function(m,n) {
			return gapfillHTML(n);
		});
	}
	function restoreGapfills(content) {
		return content.replace(/<gapfill class="mceNonEditable">(\d+)<\/gapfill>/g,function(t,n) {
			return gapfillText(n);
		});
	}

	editor.on('BeforeSetcontent', function(event){ 
		event.content = replaceGapfills( event.content );
	});

	//replace from placeholder image to shortcode
	editor.on('GetContent', function(event){
		event.content = restoreGapfills(event.content);
	});

	function promptGapNumber(callback,value) {
		editor.windowManager.open({
			title: 'Gapfill',
			body: [
				{type: 'textbox', subtype: 'number', name: 'n', label: 'Number of gap', value: value}
			],
			onsubmit: function(e) {
				var n = e.data.n;
				if(!isNaN(n)) {
					n = parseInt(n);
					callback(n);
				}
			}
		});
	}

	function insertGapfill(ui,val) {
		promptGapNumber(function(n) {
			editor.execCommand('mceInsertContent',true,gapfillHTML(n));
		},'0');
	}

	function changeGapfill(node) {
		promptGapNumber(function(n) {
			node.innerText = n;
		},node.innerText);
	}

	editor.addMenuItem('gapfill', {
		shortcut: 'Alt+G',
		text: 'Insert gap',
		onclick: insertGapfill,
		context: 'insert',
		prependToContext: true
	});

	editor.addButton('gapfill', {
		shortcut: 'Alt+G',
		classes: 'widget btn gapfill',
		text: 'G',
		tooltip: 'Insert gap',
		onclick: insertGapfill
	});

	editor.addShortcut('Alt+G','Insert gap',insertGapfill);

	editor.addCommand('insertGapfill', insertGapfill);

	editor.on('DblClick',function(e) {
		if(e.target.nodeName.toLowerCase()=='gapfill') {
			changeGapfill(e.target);
		}
	});
});
