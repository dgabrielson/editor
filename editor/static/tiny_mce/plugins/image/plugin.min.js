tinymce.PluginManager.add('image', function(editor) {
	function imageDialog(ui, val) {
		viewModel.currentTinyMCE = editor;
		var node = editor.selection.getNode();

		if(node.tagName=='IMG') {
			if($(node).hasClass('mceItemMedia')) {
				if($(node).hasClass('mceItemIframe')) {
					viewModel.iframeModal.selectedNode = node;
					viewModel.iframeModal.width($(node).width());
					viewModel.iframeModal.height($(node).height());
					$('#iframeAttributeModal').modal('show');
				}
			}
			else {
				viewModel.imageModal.selectedNode = node;
				viewModel.imageModal.width($(node).width());
				viewModel.imageModal.height($(node).height());
				viewModel.imageModal.title($(node).attr('title'));
				viewModel.imageModal.alt($(node).attr('alt'));
				$('#imageAttributeModal').modal('show');
			}
		}
		else {
			$('#imagePickModal').modal('show');
		}
	}


	editor.addButton('image', {
		icon: 'image',
		tooltip: 'Insert/edit image',
		onclick: imageDialog,
		stateSelector: 'img:not([data-mce-object],[data-mce-placeholder])'
	});

	editor.addMenuItem('image', {
		icon: 'image',
		text: 'Insert/edit image',
		onclick: imageDialog,
		context: 'insert',
		prependToContext: true
	});

	editor.addCommand('mceImage', imageDialog);
});
